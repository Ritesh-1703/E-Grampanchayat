package com.example.E_Grampanchayat.controller;

import com.example.E_Grampanchayat.model.DeathCertificate;
import com.example.E_Grampanchayat.repository.DeathCertificateRepository;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.List;

@RestController
@RequestMapping("/api/death-certificates")
@CrossOrigin(origins = "*")
public class DeathCertificateController {

    private final DeathCertificateRepository repo;

    public DeathCertificateController(DeathCertificateRepository repo) {
        this.repo = repo;
    }

    @PostMapping("/apply")
    public ResponseEntity<DeathCertificate> apply(@RequestBody DeathCertificate certificate) {
        certificate.setStatus("PENDING");
        return ResponseEntity.ok(repo.save(certificate));
    }

    @GetMapping("/user/{userId}")
    public ResponseEntity<List<DeathCertificate>> getByUserId(@PathVariable Long userId) {
        return ResponseEntity.ok(repo.findByUserId(userId));
    }

    @GetMapping("/all")
    public ResponseEntity<List<DeathCertificate>> getAll() {
        return ResponseEntity.ok(repo.findAll());
    }

    @PutMapping("/{id}/status")
    public ResponseEntity<?> updateStatus(@PathVariable Long id, @RequestParam String status) {
        return repo.findById(id).map(c -> {
            c.setStatus(status);
            return ResponseEntity.ok(repo.save(c));
        }).orElse(ResponseEntity.notFound().build());
    }

    @PostMapping("/{id}/upload")
    public ResponseEntity<?> uploadCertificate(@PathVariable Long id, @RequestParam("file") MultipartFile file) throws IOException {
        return repo.findById(id).map(c -> {
            try {
                c.setCertificateFile(file.getBytes());
                return ResponseEntity.ok(repo.save(c));
            } catch (IOException e) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
            }
        }).orElse(ResponseEntity.notFound().build());
    }

    @GetMapping("/{id}/download")
    public ResponseEntity<byte[]> downloadCertificate(@PathVariable Long id) {
        return repo.findById(id).map(c -> {
            if (c.getCertificateFile() == null) return ResponseEntity.noContent().build();
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_PDF);
            headers.setContentDisposition(ContentDisposition.inline().filename("DeathCertificate.pdf").build());
            return new ResponseEntity<>(c.getCertificateFile(), headers, HttpStatus.OK);
        }).orElse(ResponseEntity.notFound().build());
    }
}
