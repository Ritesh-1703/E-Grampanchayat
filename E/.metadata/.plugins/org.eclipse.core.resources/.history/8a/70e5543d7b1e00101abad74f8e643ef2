package com.example.E_Grampanchayat.controller;

import com.example.E_Grampanchayat.model.Payment;
import com.example.E_Grampanchayat.repository.PaymentRepository;
import jakarta.transaction.Transactional;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.List;
import java.util.Optional;

@RestController
@RequestMapping("/api/payments")
public class PaymentController {

    @Autowired
    private PaymentRepository paymentRepository;

    // ✅ GET all payments (for admin)
    @GetMapping
    public List<Payment> getAllPayments() {
        return paymentRepository.findAll();
    }

    // ✅ POST: Submit payment with screenshot (for citizen)
    @PostMapping("/submit")
    public ResponseEntity<String> submitPayment(
            @RequestParam Long userId,
            @RequestParam String purpose,
            @RequestParam double amount,
            @RequestParam("screenshot") MultipartFile screenshot
    ) {
        try {
            Payment payment = new Payment();
            payment.setUserId(userId);
            payment.setPurpose(purpose);
            payment.setAmount(amount);
            payment.setStatus("PENDING");
            payment.setPaymentDate(LocalDate.now()); // ✅ Add this line
            payment.setScreenshot(screenshot.getBytes());
            payment.setScreenshotName(screenshot.getOriginalFilename());

            paymentRepository.save(payment);
            return ResponseEntity.ok("Payment submitted successfully");
        } catch (IOException e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Failed to process screenshot.");
        }
    }


    // ✅ PUT: Update status
    @PutMapping("/{id}/status")
    @Transactional
    public ResponseEntity<String> updateStatus(@PathVariable Long id, @RequestParam String status) {
        Optional<Payment> optional = paymentRepository.findById(id);
        if (optional.isPresent()) {
            Payment payment = optional.get();
            payment.setStatus(status);
            return ResponseEntity.ok("Status updated");
        }
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body("Payment not found");
    }

    // ✅ GET screenshot
    @GetMapping("/{id}/screenshot")
    public ResponseEntity<byte[]> getScreenshot(@PathVariable Long id) {
        Optional<Payment> paymentOpt = paymentRepository.findById(id);
        if (paymentOpt.isPresent() && paymentOpt.get().getScreenshot() != null) {
            byte[] imageBytes = paymentOpt.get().getScreenshot();
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.IMAGE_JPEG); // or IMAGE_PNG based on what you allow
            return new ResponseEntity<>(imageBytes, headers, HttpStatus.OK);
        }
        return ResponseEntity.notFound().build();
    }
}
