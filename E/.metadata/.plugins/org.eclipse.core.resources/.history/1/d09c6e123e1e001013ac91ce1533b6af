package com.example.E_Grampanchayat.controller;

import com.example.E_Grampanchayat.model.Payment;
import com.example.E_Grampanchayat.repository.PaymentRepository;
import com.example.E_Grampanchayat.exception.PaymentNotFoundException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.time.LocalDate;
import java.util.List;

@RestController
@RequestMapping("/api/payments")
@CrossOrigin(origins = "http://localhost:3000")
public class PaymentController {

    @Autowired
    private PaymentRepository repo;

    @PostMapping("/submit")
    public ResponseEntity<Payment> submitPayment(
        @RequestParam Long userId,
        @RequestParam String purpose,
        @RequestParam Double amount,
        @RequestParam MultipartFile screenshot
    ) throws IOException {
        Payment payment = new Payment();
        payment.setUserId(userId);
        payment.setPurpose(purpose);
        payment.setAmount(amount);
        payment.setPaymentDate(LocalDate.now());
        payment.setStatus("PENDING");
        payment.setScreenshot(screenshot.getBytes());
        payment.setScreenshotName(screenshot.getOriginalFilename());

        return ResponseEntity.ok(repo.save(payment));
    }

    @GetMapping("/user/{userId}")
    public ResponseEntity<List<Payment>> getByUser(@PathVariable Long userId) {
        return ResponseEntity.ok(repo.findByUserId(userId));
    }

    @GetMapping
    public ResponseEntity<List<Payment>> getAllPayments() {
        return ResponseEntity.ok(repo.findAll());
    }

    @GetMapping("/{id}/screenshot")
    public ResponseEntity<byte[]> getScreenshot(@PathVariable Long id) {
        Payment payment = repo.findById(id).orElseThrow(() -> new PaymentNotFoundException(id));
        return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=" + payment.getScreenshotName())
            .contentType(MediaType.IMAGE_JPEG)
            .body(payment.getScreenshot());
    }

    @PutMapping("/{id}/status")
    public ResponseEntity<Payment> updateStatus(@PathVariable Long id, @RequestParam String status) {
        Payment payment = repo.findById(id).orElseThrow(() -> new PaymentNotFoundException(id));
        payment.setStatus(status);
        return ResponseEntity.ok(repo.save(payment));
    }
}
