package com.example.E_Grampanchayat.controller;

import com.example.E_Grampanchayat.model.Payment;
import com.example.E_Grampanchayat.repository.PaymentRepository;
import jakarta.transaction.Transactional;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

@RestController
@RequestMapping("/api/payments")
@CrossOrigin(origins = "http://localhost:3000")
public class PaymentController {

    @Autowired
    private PaymentRepository paymentRepository;

    @PostMapping("/submit")
    public ResponseEntity<String> submitPayment(
            @RequestParam Long userId,
            @RequestParam String purpose,
            @RequestParam Double amount,
            @RequestParam("screenshot") MultipartFile screenshot
    ) {
        try {
            Payment payment = new Payment();
            payment.setUserId(userId);
            payment.setPurpose(purpose);
            payment.setAmount(amount);
            payment.setStatus("PENDING");
            payment.setPaymentDate(LocalDate.now());
            payment.setScreenshot(screenshot.getBytes());
            payment.setScreenshotName(screenshot.getOriginalFilename());
            payment.setScreenshotType(screenshot.getContentType());

            paymentRepository.save(payment);
            return ResponseEntity.ok("Payment submitted successfully.");
        } catch (IOException e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("Screenshot upload failed.");
        }
    }

    @GetMapping
    public List<Payment> getAllPayments() {
        return paymentRepository.findAll();
    }

    @PutMapping("/{id}/status")
    @Transactional
    public ResponseEntity<String> updateStatus(@PathVariable Long id, @RequestParam String status) {
        Optional<Payment> optional = paymentRepository.findById(id);
        if (optional.isPresent()) {
            Payment payment = optional.get();
            payment.setStatus(status);
            return ResponseEntity.ok("Status updated");
        } else {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body("Payment not found");
        }
    }

    @GetMapping("/{id}/screenshot")
    public ResponseEntity<byte[]> getScreenshot(@PathVariable Long id) {
        Optional<Payment> optional = paymentRepository.findById(id);
        if (optional.isPresent()) {
            Payment payment = optional.get();
            byte[] data = payment.getScreenshot();
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.valueOf(payment.getScreenshotType()));
            headers.setContentDisposition(ContentDisposition.inline().filename(payment.getScreenshotName()).build());
            return new ResponseEntity<>(data, headers, HttpStatus.OK);
        } else {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).build();
        }
    }
}
